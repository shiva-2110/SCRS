<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Smart CropX Admin - User Management
           </title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body{background:linear-gradient(135deg,#f5f7fa,#c3cfe2);min-height:100vh}
    .container{max-width:900px;margin-top:40px}
    .logo{height:56px}
    .table-actions{display:flex;gap:8px}
  </style>
</head>
<body>
  <div class="container bg-white rounded shadow p-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h3 id="adminHeader">Admin Dashboard</h3>
      <div>
        <button id="btnRetrain" class="btn btn-sm btn-outline-primary me-2">Retrain</button>
        <button id="btnLogout" class="btn btn-sm btn-outline-secondary">Logout</button>
      </div>
    </div>

    <div id="msg"></div>

  <div id="retrainMsg" style="margin-top:8px"></div>
    <div class="mt-3 mb-3">
      <label class="form-label">IoT Broker</label>
      <div class="input-group mb-2">
        <input id="iotBroker" class="form-control" placeholder="mqtt://broker.example or IP" />
        <input id="iotTopic" class="form-control" placeholder="topic (e.g. sensors/#)" />
        <button id="btnIotStart" class="btn btn-sm btn-outline-success" type="button">Start MQTT</button>
        <button id="btnIotStop" class="btn btn-sm btn-outline-danger" type="button">Stop MQTT</button>
      </div>
      <div id="iotLatest" class="text-muted">No IoT data yet</div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-2">
      <h5>Registered Users</h5>
      <div class="d-flex gap-2 align-items-center">
        <input id="searchInput" class="form-control form-control-sm" placeholder="Search by name or mobile" style="width:260px;">
        <button id="btnRefresh" class="btn btn-sm btn-outline-primary">Refresh</button>
      </div>
    </div>

    <div class="mt-4">
  <h5>User Feedback</h5>
  <button id="btnLoadFeedback" class="btn btn-sm btn-outline-info mb-2">Load Feedback</button>
  <div id="feedbackArea" class="table-responsive">
    <table class="table table-bordered">
      <thead><tr><th>User</th><th>Crop</th><th>Source</th><th>Timestamp</th></tr></thead>
      <tbody id="feedbackTbody"></tbody>
    </table>
  </div>
</div>


    
    <div id="usersArea" class="table-responsive">
      <table class="table table-striped">
        <thead><tr><th>ID</th><th>Name</th><th>Mobile</th><th>Address</th><th>Created</th><th>Actions</th></tr></thead>
        <tbody id="usersTbody"></tbody>
      </table>
    </div>
  </div>

  <script>
    const token = localStorage.getItem('adminToken');
    const BASE_URL = 'https://scrs-0sgn.onrender.com';

    if(!token){
      // redirect to login if not logged in
      location.href = '/admin/login';
    }

    async function fetchUsers(){
      try{
        const res = await fetch('${BASE_URL}/api/admin/users',{headers:{'X-Admin-Token':token}});
        if(!res.ok){
          document.getElementById('msg').innerHTML = '<div class="alert alert-danger">Failed to load users</div>';
          return;
        }
        const data = await res.json();
        // store users for client-side filtering
        window._adminUsers = data.users || [];
        renderUserTable(window._adminUsers);
      }catch(err){
        document.getElementById('msg').innerHTML = '<div class="alert alert-danger">Could not contact server</div>';
      }
    }

    function renderUserTable(users){
      const tbody = document.getElementById('usersTbody');
      tbody.innerHTML = '';
      users.forEach(u=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${u.id}</td><td>${u.name}</td><td>${u.mobile}</td><td>${u.address}</td><td>${u.created_at}</td><td class="table-actions"><button data-id="${u.id}" class="btn btn-sm btn-danger btn-delete">Delete</button></td>`;
        tbody.appendChild(tr);
      });
      document.querySelectorAll('.btn-delete').forEach(b=> b.addEventListener('click', deleteUser));
    }

    async function deleteUser(e){
      const id = e.currentTarget.getAttribute('data-id');
      if(!confirm('Delete user ID '+id+'?')) return;
      try{
        const res = await fetch(`${BASE_URL}/api/admin/user/${id}/delete`,{method:'POST',headers:{'X-Admin-Token':token}});
        const data = await res.json();
        if(res.ok){
          fetchUsers();
        } else {
          document.getElementById('msg').innerHTML = `<div class="alert alert-danger">${data.error||'Delete failed'}</div>`;
        }
      }catch(err){
        document.getElementById('msg').innerHTML = '<div class="alert alert-danger">Could not contact server</div>';
      }
    }

    document.getElementById('btnLogout').addEventListener('click',()=>{
      localStorage.removeItem('adminToken');
      localStorage.removeItem('username');
      localStorage.removeItem('mobile');
      location.href='/admin/login';
    });

    document.getElementById('btnRefresh').addEventListener('click', ()=> fetchUsers());
    document.getElementById('searchInput').addEventListener('input', function(){
      const q = this.value.trim().toLowerCase();
      if(!q) return renderUserTable(window._adminUsers);
      const filtered = (window._adminUsers||[]).filter(u => (u.name||'').toLowerCase().includes(q) || (u.mobile||'').includes(q));
      renderUserTable(filtered);
    });

    // show admin username if available and localize Logout text
    (function(){
      const adminName = localStorage.getItem('username') || 'Admin';
      const lang = localStorage.getItem('lang') || 'en';
      const header = document.getElementById('adminHeader');
      if(header) header.innerText = `Admin Dashboard — ${adminName}`;
      const logoutBtn = document.getElementById('btnLogout');
      const logoutMap = { en: 'Logout', hi: 'लॉगआऊट', mr: 'लॉगआऊट' };
      if(logoutBtn) logoutBtn.innerText = logoutMap[lang] || logoutMap['en'];
    })();

    fetchUsers();

   document.getElementById('btnRetrain').addEventListener('click', async function(){
  const retrainMsg = document.getElementById('retrainMsg');
  retrainMsg.innerHTML = '<div class="text-info">Retraining model (this may take a moment)...</div>';
  try {
    const res = await fetch(`${BASE_URL}/api/admin/retrain`, { method: 'POST', headers: { 'X-Admin-Token': token } });
    const data = await res.json();
    if (!res.ok || !data.job_id) {
      retrainMsg.innerHTML = `<div class="text-danger">${data.error || 'Retrain failed'}</div>`;
      return;
    }
    const jobId = data.job_id;
    const pollStatus = async () => {
      const statusRes = await fetch(`${BASE_URL}/api/admin/retrain/status/${jobId}`, { headers: { 'X-Admin-Token': token } });
      const statusData = await statusRes.json();
      if (statusData.status === 'finished') {
        retrainMsg.innerHTML = '<div class="text-success">Retrain completed successfully.</div>';
      } else if (statusData.status === 'error') {
        retrainMsg.innerHTML = `<div class="text-danger">Error: ${statusData.error}</div>`;
      } else {
        retrainMsg.innerHTML = `<div class="text-info">Retrain in progress... ${statusData.progress}%</div>`;
        setTimeout(pollStatus, 2000);
      }
    };
    pollStatus();
  } catch (err) {
    retrainMsg.innerHTML = '<div class="text-danger">Could not contact server</div>';
  }
});


    // Start/Stop MQTT
    document.getElementById('btnIotStart').addEventListener('click', async function(){
      const broker = document.getElementById('iotBroker').value.trim();
      const topic = document.getElementById('iotTopic').value.trim();
      if(!broker || !topic){ alert('Enter broker and topic'); return; }
      try{
        const res = await fetch('${BASE_URL}/api/iot/start',{method:'POST',headers:{'Content-Type':'application/json','X-Admin-Token':token},body:JSON.stringify({broker,topic})});
        const data = await res.json();
        if(res.ok) document.getElementById('iotLatest').innerText = 'MQTT started'; else document.getElementById('iotLatest').innerText = data.error || 'Start failed';
      }catch(e){ document.getElementById('iotLatest').innerText = 'Could not contact server'; }
    });

    document.getElementById('btnIotStop').addEventListener('click', async function(){
      try{
        const res = await fetch('${BASE_URL}/api/iot/stop',{method:'POST',headers:{'X-Admin-Token':token}});
        const data = await res.json();
        if(res.ok) document.getElementById('iotLatest').innerText = 'MQTT stopped'; else document.getElementById('iotLatest').innerText = data.error || 'Stop failed';
      }catch(e){ document.getElementById('iotLatest').innerText = 'Could not contact server'; }
    });



    document.getElementById('btnLoadFeedback').addEventListener('click', async function(){
  try {
    const res = await fetch(`${BASE_URL}/api/admin/feedback`, { headers: { 'X-Admin-Token': token } });
    const data = await res.json();
    const tbody = document.getElementById('feedbackTbody');
    tbody.innerHTML = '';
    (data.feedback || []).forEach(f => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${f.mobile}</td><td>${f.actual_crop}</td><td>${f.input_source || 'N/A'}</td><td>${f.created_at}</td>`;
      tbody.appendChild(tr);
    });
  } catch (err) {
    document.getElementById('feedbackArea').innerHTML = '<div class="alert alert-danger">Could not load feedback</div>';
  }
});



    

    // Poll latest IoT data every 5s
    setInterval(async ()=>{
      try{
        const res = await fetch('${BASE_URL}/api/iot/latest',{headers:{'X-Admin-Token':token}});
        if(!res.ok) return;
        const d = await res.json();
        document.getElementById('iotLatest').innerText = `Topic: ${d.topic} @ ${d.timestamp} — ${JSON.stringify(d.data)}`;
      }catch(e){}
    },5000);
  </script>
</body>
</html>










