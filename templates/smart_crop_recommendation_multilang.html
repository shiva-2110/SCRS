<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Crop Recommendation System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
   <style>
    /* Background + overlay (place last to override Bootstrap) */
    html, body { height:100%; margin:0; font-family:'Segoe UI',Roboto,Arial,sans-serif; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
    body {
      background-image: url("{{ url_for('static', filename='images/bg-field.jpg') }}") !important;
      background-size: cover !important;
      background-position: center center !important;
      background-repeat: no-repeat !important;
      background-attachment: fixed !important;
      color: #fff !important;
    }
    body::before {
      content: "" !important;
      position: fixed !important;
      inset: 0 !important;
      background: rgba(6,40,8,0.36) !important;
      pointer-events: none !important;
      z-index: 0 !important;
    }

    /* Card container above overlay */
    .container {
      max-width: 700px;
      margin: 40px auto;
      background: rgba(255,255,255,0.06) !important;
      box-shadow: 0 8px 32px rgba(0,0,0,0.45) !important;
      border-radius: 24px;
      border: 1px solid rgba(255,255,255,0.08);
      padding: 2.5rem 2rem;
      position: relative;
      z-index: 1;
      backdrop-filter: blur(6px);
    }

    /* Typography and small UI tweaks */
    h2 {
      background: linear-gradient(90deg,#fcb69f 0%,#ffecd2 100%);
      -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent;
      font-weight:700; font-size:2.2rem; text-align:center;
    }
    .lang-select { margin-bottom:1.5rem; text-align:right; }
    .graphic { display:flex; justify-content:center; margin-bottom:1.5rem; }
    .croplogo { width:120px; height:120px; border-radius:16px; box-shadow:0 4px 16px rgba(0,0,0,0.35); background:rgba(255,255,255,0.9); object-fit:cover; }

    /* Form controls visible on dark overlay */
    .form-control, .form-select {
      background: rgba(255,255,255,0.04) !important;
      color: #fff !important;
      border: 1px solid rgba(255,255,255,0.12) !important;
    }
    .form-control::placeholder { color: rgba(255,255,255,0.6) !important; }
    label { color: #f1f1f1 !important; font-weight:600; }

    /* Buttons */
    .btn-success {
      background: linear-gradient(90deg,#39b54a,#1d8f2a) !important;
      border: none !important; color: #fff !important; font-weight:700;
    }
    .btn-outline-secondary { color:#fff !important; border-color: rgba(255,255,255,0.12) !important; }

    /* Alerts and debug */
    #alertList { color: #ffdddd; }
    pre#debugOut { background: rgba(255,255,255,0.06); color: #fff; border-radius:8px; padding:12px; }

    @media (max-width:640px) {
      .container { margin:20px; padding:18px; }
      h2 { font-size:1.6rem; }
    }
  </style>
</head>
<body>
    <script>
        // Navigation guard: allow prediction page only when navigated from site
        (function(){
            try{
                const fromMain = sessionStorage.getItem('fromMain') === '1';
                const ref = document.referrer || '';
                const fromRef = ref.indexOf('smart_crop_system_main.html') !== -1 || ref.indexOf('smart_crop_system_info.html') !== -1 || ref.indexOf('login.html') !== -1 || ref.indexOf('register.html') !== -1;
                if(!fromMain && !fromRef){
                    // not allowed, redirect to main
                    window.location.href = '{{url_for('main_page')}}';
                } else {
                    // clear flag so reload doesn't bypass
                    sessionStorage.removeItem('fromMain');
                }
            }catch(e){
                // on error, be safe and redirect
                try{ window.location.href = '{{url_for('main_page')}}'; }catch(e){}
            }
        })();
    </script>
    <div class="container">
        <div class="graphic" style="flex-direction:column;align-items:center;">
            <a href="{{url_for('main_page')}}" aria-label="Go to main page">
                <img src="{{ url_for('static', filename='images/CROPx.png') }}" alt="CROPx Logo - Go to main page" class="croplogo mb-2" />
            </a>
            <div class="lang-select" style="width:100%;text-align:right;">
                <label for="language" class="visually-hidden">Select Language</label>
                <select id="language" class="form-select w-auto d-inline-block">
                    <option value="en">English</option>
                    <option value="hi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</option>
                    <option value="mr">‡§Æ‡§∞‡§æ‡§†‡•Ä</option>
                </select>
            </div>
        </div>
                <h2 id="title">Smart Crop Recommendation System</h2>
        <p id="desc" class="lead mb-4" style="text-align:center;">Empowering farmers with AI-driven decisions for a sustainable future.</p>
        <div class="d-flex justify-content-between align-items-center" style="margin-bottom:8px;">
            <p id="welcome" class="text-center" style="font-weight:600;color:#4b2c83;margin-bottom:0;display:none;"></p>
            <div class="d-flex align-items-center">
                <small id="logoutCountdown" class="text-muted me-2" style="display:none"></small>
                <div><button id="btnLogout" class="btn btn-outline-secondary btn-sm" style="display:none">Logout</button></div>
            </div>
        </div>
        <form id="cropForm">
            <div class="mb-3">
                <label for="inputSource" class="form-label">Input Source</label>
                <select id="inputSource" class="form-select">
                    <option value="user">User Input</option>
                    <option value="iot">IoT Sensor</option>
                </select>
            </div>
            <div id="iotSettings" style="display:none;margin-bottom:12px;">
                <label class="form-label">IoT Device Connection</label>
                <div class="input-group mb-2">
                    <input id="iotEndpoint" class="form-control" placeholder="Enter IoT HTTP endpoint (e.g. http://192.168.1.50/sensor)" />
                    <button id="btnIotConnect" class="btn btn-outline-primary" type="button">Connect</button>
                </div>
                <div class="d-flex gap-2 align-items-center">
                    <button id="btnIotFetch" class="btn btn-sm btn-outline-secondary">Fetch Sensor Now</button>
                    <button id="btnIotPoll" class="btn btn-sm btn-outline-secondary">Start Polling</button>
                    <div id="iotStatus" class="ms-2 text-muted">Not connected</div>
                </div>
            </div>
            <div class="mb-3">
                <label for="N" class="form-label" id="labelN">Nitrogen (N)</label>
                <input type="number" class="form-control" id="N" min="0" max="140" required>
            </div>
            <div class="mb-3">
                <label for="P" class="form-label" id="labelP">Phosphorus (P)</label>
                <input type="number" class="form-control" id="P" min="0" max="140" required>
            </div>
            <div class="mb-3">
                <label for="K" class="form-label" id="labelK">Potassium (K)</label>
                <input type="number" class="form-control" id="K" min="0" max="140" required>
            </div>
            <div class="mb-3">
                <label for="temperature" class="form-label" id="labelTemp">Temperature (¬∞C)</label>
                <input type="number" step="0.1" class="form-control" id="temperature" min="0" max="50" required>
            </div>
            <div class="mb-3">
                <label for="humidity" class="form-label" id="labelHum">Humidity (%)</label>
                <input type="number" step="0.1" class="form-control" id="humidity" min="0" max="100" required>
            </div>
            <div class="mb-3">
                <label for="ph" class="form-label" id="labelPh">pH</label>
                <input type="number" step="0.1" class="form-control" id="ph" min="3.5" max="9.5" required>
            </div>
            <div class="mb-3">
                <label for="rainfall" class="form-label" id="labelRain">Rainfall (mm)</label>
                <input type="number" step="0.1" class="form-control" id="rainfall" min="0" max="1000" required>
            </div>
            <hr>
<!-- <h5>Disease Risk Prediction (Optional)</h5> -->

<div class="mb-3">
    <label for="cropType" class="form-label">Crop Type</label>
    <select id="cropType" class="form-select">
        <option value="">-- Select Crop --</option>
        <option value="wheat">Wheat</option>
        <option value="rice">Rice</option>
        <option value="maize">Maize</option> 
      
     </select> 
</div>

<div class="mb-3">
    <label for="leafImage" class="form-label">Upload Leaf Image</label>
    <input type="file" class="form-control" id="leafImage" accept="image/*">
</div> 

            <button type="submit" class="btn btn-success w-100" id="btnPredict">Recommend Crop</button>

            <div style="margin-top: 10px;">
                <a href="/disease-predict" class="text-primary" style="text-decoration: underline;"> üåæ Predict Crop Disease</a>
            </div>
        </form>
            <div class="form-check form-switch my-3">
                <input class="form-check-input" type="checkbox" id="debugMode">
                <label class="form-check-label" for="debugMode">Debug mode (show transformed features & probs)</label>
            </div>
            <div class="result text-center" id="result"></div>
          <div id="alertSection" class="mt-4" style="display:none;">
            <h5>‚ö†Ô∏è Disease Alerts</h5>
            <div id="alertList" class="text-danger fw-bold"></div>
            </div>

            <pre id="debugOut" style="white-space:pre-wrap;background:#f8f9fa;border-radius:8px;padding:12px;margin-top:12px;display:none;max-height:300px;overflow:auto;"></pre>
            <div id="feedbackArea" style="display:none;margin-top:12px;">
                <label for="actualCrop">If you planted a different crop, tell us (feedback):</label>
                <select id="actualCrop" class="form-select mt-1">
                    <option value="">-- select actual crop --</option>
                </select>
                <button id="btnFeedback" class="btn btn-outline-success btn-sm mt-2">Submit Feedback</button>
                <div id="feedbackMsg" style="margin-top:8px"></div>
            </div>
    </div>
    <script>
        // Translations
        const translations = {
            en: {
                title: "Smart Crop Recommendation System",
                desc: "Empowering farmers with AI-driven decisions for a sustainable future.",
                welcome: "Welcome",
                logout: "Logout",
                labelN: "Nitrogen (N)",
                labelP: "Phosphorus (P)",
                labelK: "Potassium (K)",
                labelTemp: "Temperature (¬∞C)",
                labelHum: "Humidity (%)",
                labelPh: "pH",
                labelRain: "Rainfall (mm)",
                btnPredict: "Recommend Crop"
            },
            hi: {
                title: "‡§∏‡•ç‡§Æ‡§æ‡§∞‡•ç‡§ü ‡§´‡§∏‡§≤ ‡§Ö‡§®‡•Å‡§∂‡§Ç‡§∏‡§æ ‡§™‡•ç‡§∞‡§£‡§æ‡§≤‡•Ä",
                desc: "‡§ï‡§ø‡§∏‡§æ‡§®‡•ã‡§Ç ‡§ï‡•ã ‡§è‡§Ü‡§à-‡§∏‡§Ç‡§ö‡§æ‡§≤‡§ø‡§§ ‡§®‡§ø‡§∞‡•ç‡§£‡§Ø‡•ã‡§Ç ‡§ï‡•á ‡§∏‡§æ‡§• ‡§∏‡§∂‡§ï‡•ç‡§§ ‡§¨‡§®‡§æ‡§®‡§æ, ‡§è‡§ï ‡§ü‡§ø‡§ï‡§æ‡§ä ‡§≠‡§µ‡§ø‡§∑‡•ç‡§Ø ‡§ï‡•á ‡§≤‡§ø‡§è‡•§",
                labelN: "‡§®‡§æ‡§á‡§ü‡•ç‡§∞‡•ã‡§ú‡§® (N)",
                labelP: "‡§´‡•â‡§∏‡•ç‡§´‡•ã‡§∞‡§∏ (P)",
                labelK: "‡§™‡•ã‡§ü‡•á‡§∂‡§ø‡§Ø‡§Æ (K)",
                labelTemp: "‡§§‡§æ‡§™‡§Æ‡§æ‡§® (¬∞C)",
                labelHum: "‡§Ü‡§∞‡•ç‡§¶‡•ç‡§∞‡§§‡§æ (%)",
                labelPh: "‡§™‡•Ä‡§è‡§ö",
                labelRain: "‡§µ‡§∞‡•ç‡§∑‡§æ (‡§Æ‡§ø‡§Æ‡•Ä)",
                btnPredict: "‡§´‡§∏‡§≤ ‡§Ö‡§®‡•Å‡§∂‡§Ç‡§∏‡§æ ‡§ï‡§∞‡•á‡§Ç"
            },
            mr: {
                title: "‡§∏‡•ç‡§Æ‡§æ‡§∞‡•ç‡§ü ‡§™‡•Ä‡§ï ‡§∂‡§ø‡§´‡§æ‡§∞‡§∏ ‡§™‡•ç‡§∞‡§£‡§æ‡§≤‡•Ä",
                desc: "‡§∂‡•á‡§§‡§ï‡§±‡•ç‡§Ø‡§æ‡§Ç‡§®‡§æ ‡§è‡§Ü‡§Ø-‡§Ü‡§ß‡§æ‡§∞‡§ø‡§§ ‡§®‡§ø‡§∞‡•ç‡§£‡§Ø‡§æ‡§Ç‡§∏‡§π ‡§∏‡§ï‡•ç‡§∑‡§Æ ‡§¨‡§®‡§µ‡§£‡•á, ‡§∂‡§æ‡§∂‡•ç‡§µ‡§§ ‡§≠‡§µ‡§ø‡§∑‡•ç‡§Ø‡§æ‡§∏‡§æ‡§†‡•Ä.",
                welcome: "‡§∏‡•ç‡§µ‡§æ‡§ó‡§§ ‡§Ü‡§π‡•á",
                logout: "‡§≤‡•â‡§ó‡§Ü‡§ä‡§ü",
                labelN: "‡§®‡§æ‡§Ø‡§ü‡•ç‡§∞‡•ã‡§ú‡§® (N)",
                labelP: "‡§´‡•â‡§∏‡•ç‡§´‡§∞‡§∏ (P)",
                labelK: "‡§™‡•ã‡§ü‡•Ö‡§∂‡§ø‡§Ø‡§Æ (K)",
                labelTemp: "‡§§‡§æ‡§™‡§Æ‡§æ‡§® (¬∞C)",
                labelHum: "‡§Ü‡§∞‡•ç‡§¶‡•ç‡§∞‡§§‡§æ (%)",
                labelPh: "pH",
                labelRain: "‡§™‡§æ‡§ä‡§∏ (‡§Æ‡§ø‡§Æ‡•Ä)",
                btnPredict: "‡§™‡•Ä‡§ï ‡§∂‡§ø‡§´‡§æ‡§∞‡§∏ ‡§ï‡§∞‡§æ"
            }
        };
        function setLanguage(lang) {
            document.getElementById('title').innerText = translations[lang].title;
            document.getElementById('desc').innerText = translations[lang].desc;
            document.getElementById('labelN').innerText = translations[lang].labelN;
            document.getElementById('labelP').innerText = translations[lang].labelP;
            document.getElementById('labelK').innerText = translations[lang].labelK;
            document.getElementById('labelTemp').innerText = translations[lang].labelTemp;
            document.getElementById('labelHum').innerText = translations[lang].labelHum;
            document.getElementById('labelPh').innerText = translations[lang].labelPh;
            document.getElementById('labelRain').innerText = translations[lang].labelRain;
            document.getElementById('btnPredict').innerText = translations[lang].btnPredict;
            // logout button and persisted language
            try{
                const logoutBtn = document.getElementById('btnLogout');
                if(logoutBtn) logoutBtn.innerText = translations[lang].logout || 'Logout';
            }catch(e){}
            try{ localStorage.setItem('lang', lang); }catch(e){}
        }
        document.getElementById('language').addEventListener('change', function() {
            setLanguage(this.value);
        });
        // Initialize language from saved preference or default to English
        const savedLang = localStorage.getItem('lang') || 'en';
        document.getElementById('language').value = savedLang;
        setLanguage(savedLang);

        // Show welcome if user is logged-in (use selected language)
        (function(){
            const uname = localStorage.getItem('username');
            const lang = localStorage.getItem('lang') || 'en';
            if(uname){
                const w = document.getElementById('welcome');
                w.style.display = '';
                const prefix = (translations[lang] && translations[lang].welcome) ? translations[lang].welcome : 'Welcome';
                w.innerText = `${prefix} ${uname}`;
            }
            // ensure logout text is set even if user arrives directly
            const logoutBtn = document.getElementById('btnLogout');
            if(logoutBtn){ logoutBtn.style.display = '';
                logoutBtn.innerText = (translations[lang] && translations[lang].logout) ? translations[lang].logout : 'Logout';
            }
        })();

        // Hide/show form fields based on input source
        document.getElementById('inputSource').addEventListener('change', function() {
            const isUser = this.value === 'user';
            document.getElementById('N').disabled = !isUser;
            document.getElementById('P').disabled = !isUser;
            document.getElementById('K').disabled = !isUser;
            document.getElementById('temperature').disabled = !isUser;
            document.getElementById('humidity').disabled = !isUser;
            document.getElementById('ph').disabled = !isUser;
            document.getElementById('rainfall').disabled = !isUser;
        });
        document.getElementById('inputSource').dispatchEvent(new Event('change'));

        document.getElementById('cropForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            let payload;
            const cropType = document.getElementById('cropType').value;
            const leafImage = document.getElementById('leafImage').files[0];

if (cropType && leafImage) {
    const diseaseForm = new FormData();
    diseaseForm.append('crop_type', cropType);
    diseaseForm.append('location', payload.location || ''); // reuse location
    diseaseForm.append('leaf_image', leafImage);

    try {
        const diseaseRes = await fetch('https://scrs-0sgn.onrender.com/api/predict_disease', {
            method: 'POST',
            body: diseaseForm
        });
        const diseaseData = await diseaseRes.json();
        if (diseaseData.disease) {
            document.getElementById('result').innerText += `\nü¶† Disease Risk: ${diseaseData.disease} (${diseaseData.risk_level})\nüí° Suggestion: ${diseaseData.suggestion}`;
        }
    } catch {
        document.getElementById('result').innerText += '\n‚ö†Ô∏è Disease prediction failed.';
    }
}

            if (document.getElementById('inputSource').value === 'user') {
                payload = {
                    N: document.getElementById('N').value,
                    P: document.getElementById('P').value,
                    K: document.getElementById('K').value,
                    temperature: document.getElementById('temperature').value,
                    humidity: document.getElementById('humidity').value,
                    ph: document.getElementById('ph').value,
                    rainfall: document.getElementById('rainfall').value
                };
            } else {
                // Simulate IoT sensor input (fetch from local file or API)
                // For demo, use hardcoded values or fetch from 'sensor_data.json' if available
                try {
                    const response = await fetch('sensor_data.json');
                    const data = await response.json();
                    payload = {
                        N: data.N,
                        P: data.P,
                        K: data.K,
                        temperature: data.temperature,
                        humidity: data.humidity,
                        ph: data.ph,
                        rainfall: data.rainfall
                    };
                } catch {
                    // Fallback demo values
                    payload = {
                        N: 20, P: 50, K: 50, temperature: 20.0, humidity: 80, ph: 50, rainfall: 500
                    };
                }
            }
            try {
                // require logged-in (registered) user ‚Äî attach mobile from localStorage
                const storedMobile = localStorage.getItem('mobile');
                if(!storedMobile){
                    alert('Please register or login before predicting. You will be redirected to the login page.');
                    window.location.href = '{{url_for('login_page')}}';
                    return;
                }
                payload.mobile = storedMobile;

                
                // üîî Fetch disease alerts for this mobile number
try {
    const alertRes = await fetch('https://scrs-0sgn.onrender.com/api/alerts?mobile=' + storedMobile);
    const alertData = await alertRes.json();
    if (alertData.alerts && alertData.alerts.length > 0) {
        const alertList = document.getElementById('alertList');
        alertList.innerHTML = '';
        alertData.alerts.forEach(a => {
            const div = document.createElement('div');
            div.innerText = `${a.disease} risk in ${a.location}: ${a.level}`;
            alertList.appendChild(div);
        });
        document.getElementById('alertSection').style.display = '';
    }
} catch {}
                // include debug flag when checkbox checked
                const debugMode = document.getElementById('debugMode').checked;
                const response = await fetch('https://scrs-0sgn.onrender.com/api/recommend', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(Object.assign({}, payload, { input_source: document.getElementById('inputSource').value }, debugMode ? {debug:true} : {}))
                });
                const data = await response.json();
                if (data.crop) {
                    document.getElementById('result').innerText = `${data.crop} is the best crop to be cultivated.`;
                    // show feedback area and populate crops
                    const feedbackArea = document.getElementById('feedbackArea');
                    const actualSelect = document.getElementById('actualCrop');
                    feedbackArea.style.display = '';
                    // store returned prediction_id so we can reference it when submitting feedback
                    window._lastPredictionId = data.prediction_id || null;
                    // populate options if empty
                    if(actualSelect.options.length <= 1){
                        Object.values(translations).length; // noop to reference translations
                        const crops = ["Rice","Maize","Jute","Cotton","Coconut","Papaya","Orange","Apple","Muskmelon","Watermelon","Grapes","Mango","Banana","Pomegranate","Lentil","Blackgram","Mungbean","Mothbeans","Pigeonpeas","Kidneybeans","Chickpea","Coffee"];
                        crops.forEach(c=>{ const o = document.createElement('option'); o.value = c; o.text = c; actualSelect.appendChild(o); });
                    }
                    // start auto-logout countdown (2 minutes)
                    try{ if(window.startAutoLogout) window.startAutoLogout(); }catch(e){}
                } else {
                    document.getElementById('result').innerText = 'Sorry, unable to recommend a crop for this environment.';
                }
                // show debug output if present
                const dbg = document.getElementById('debugOut');
                if(data.transformed || data.probs || data.prediction_raw){
                    dbg.style.display = '';
                    dbg.textContent = JSON.stringify(data, null, 2);
                } else {
                    dbg.style.display = 'none';
                    dbg.textContent = '';
                }
            } catch (err) {
                document.getElementById('result').innerText = 'Error: Could not connect to backend.';
            }
        });

        // handle feedback submission
        document.getElementById('btnFeedback').addEventListener('click', async function(){
            const actual = document.getElementById('actualCrop').value;
            const mobile = localStorage.getItem('mobile');
            const feedbackMsg = document.getElementById('feedbackMsg');
            if(!actual){ feedbackMsg.innerHTML = '<div class="text-danger">Select a crop before submitting feedback.</div>'; return; }
            // only allow feedback if the last prediction was produced from IoT source
            const lastSrc = document.getElementById('inputSource').value;
            if(lastSrc !== 'iot' && !window._lastPredictionId){
                feedbackMsg.innerHTML = '<div class="text-danger">Feedback is accepted only for IoT-sensor predictions.</div>';
                return;
            }
            try{
                const payload = { mobile, actual_crop: actual };
                // include prediction id only when input source was IoT and we have one
                if(window._lastPredictionId) payload.prediction_id = window._lastPredictionId;
                const res = await fetch('https://scrs-0sgn.onrender.com/api/feedback',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
                const data = await res.json();
                if(res.ok){ feedbackMsg.innerHTML = '<div class="text-success">Thank you ‚Äî feedback recorded.</div>'; } else { feedbackMsg.innerHTML = `<div class="text-danger">${data.error||'Feedback failed'}</div>`; }
            }catch(err){ feedbackMsg.innerHTML = '<div class="text-danger">Could not contact server</div>'; }
        });

        // IoT connection and polling logic
        (function(){
            const iotSettings = document.getElementById('iotSettings');
            const inputSource = document.getElementById('inputSource');
            const iotEndpoint = document.getElementById('iotEndpoint');
            const btnConnect = document.getElementById('btnIotConnect');
            const btnFetch = document.getElementById('btnIotFetch');
            const btnPoll = document.getElementById('btnIotPoll');
            const iotStatus = document.getElementById('iotStatus');
            let pollHandle = null;

            function updateIotVisibility(){
                if(inputSource.value === 'iot'){ iotSettings.style.display = ''; } else { iotSettings.style.display = 'none'; }
            }
            inputSource.addEventListener('change', updateIotVisibility);
            updateIotVisibility();

            btnConnect.addEventListener('click', function(){
                const url = iotEndpoint.value.trim();
                if(!url){ iotStatus.innerText = 'Enter endpoint'; return; }
                // test endpoint
                fetch(url).then(r=>r.json()).then(d=>{ iotStatus.innerText = 'Connected'; localStorage.setItem('iotEndpoint', url); }).catch(e=>{ iotStatus.innerText = 'Connect failed'; });
            });

            btnFetch.addEventListener('click', async function(){
                const url = iotEndpoint.value.trim() || localStorage.getItem('iotEndpoint');
                if(!url){ iotStatus.innerText = 'No endpoint'; return; }
                try{
                    const res = await fetch(url);
                    const data = await res.json();
                    // populate fields with returned data (if keys exist)
                    ['N','P','K','temperature','humidity','ph','rainfall'].forEach(k=>{ if(k in data) { const el = document.getElementById(k); if(el) el.value = data[k]; } });
                    iotStatus.innerText = 'Fetched';
                }catch(e){ iotStatus.innerText = 'Fetch failed'; }
            });

            btnPoll.addEventListener('click', function(){
                const url = iotEndpoint.value.trim() || localStorage.getItem('iotEndpoint');
                if(!url){ iotStatus.innerText = 'No endpoint'; return; }
                if(pollHandle){ clearInterval(pollHandle); pollHandle = null; btnPoll.innerText = 'Start Polling'; iotStatus.innerText = 'Polling stopped'; return; }
                pollHandle = setInterval(async ()=>{
                    try{
                        const res = await fetch(url); const data = await res.json();
                        ['N','P','K','temperature','humidity','ph','rainfall'].forEach(k=>{ if(k in data){ const el = document.getElementById(k); if(el) el.value = data[k]; } });
                        iotStatus.innerText = 'Polled';
                    }catch(e){ iotStatus.innerText = 'Poll error'; }
                }, 30000); // poll every 30s
                btnPoll.innerText = 'Stop Polling'; iotStatus.innerText = 'Polling...';
            });
        })();

        // Auto-logout timer: 2 minutes after each successful prediction
        (function(){
            const logoutBtn = document.getElementById('btnLogout');
            const countdownEl = document.getElementById('logoutCountdown');
            let logoutTimer = null;
            let remaining = 0;

            function startLogoutTimer(seconds){
                if(logoutTimer) clearInterval(logoutTimer);
                remaining = seconds;
                countdownEl.style.display = '';
                logoutTimer = setInterval(()=>{
                    remaining -= 1;
                    if(remaining <= 0){ clearInterval(logoutTimer); logoutTimer = null; performLogout(); return; }
                    countdownEl.innerText = `Auto logout in ${remaining}s`;
                }, 1000);
            }

            function performLogout(){
                localStorage.removeItem('mobile');
                localStorage.removeItem('username');
                localStorage.removeItem('adminToken');
                window.location.href = '{{url_for('login_page')}}';
            }

            // expose hook for other code to start timer
            window.startAutoLogout = function(){
                // 120 seconds (2 minutes)
                startLogoutTimer(120);
            };

            // bind visible logout button
            logoutBtn.addEventListener('click', function(){ if(logoutTimer){ clearInterval(logoutTimer); } performLogout(); });
        })();

        // Show logout and enforce registration on page load
        (function(){
            const logoutBtn = document.getElementById('btnLogout');
            const uname = localStorage.getItem('username');
            const mobile = localStorage.getItem('mobile');
            if(uname){
                const w = document.getElementById('welcome');
                w.style.display = '';
                w.innerText = `Welcome ${uname}`;
            }
            if(!mobile){
                // no registered user ‚Äî prevent prediction use
                alert('Please register or login before predicting a crop. Redirecting to login.');
                window.location.href = '{{url_for('login_page')}}';
                return;
            }
            // show logout when user is present
            logoutBtn.style.display = '';
            logoutBtn.addEventListener('click', function(){
                localStorage.removeItem('mobile');
                localStorage.removeItem('username');
                localStorage.removeItem('adminToken');
                window.location.href = '{{url_for('login_page')}}';
            });
        })();
    </script>
    <script>
document.getElementById("cropForm").addEventListener("submit", function(e) {
  const fields = [
    { id: "N", min: 0, max: 140 },
    { id: "P", min: 0, max: 140 },
    { id: "K", min: 0, max: 140 },
    { id: "temperature", min: 0, max: 50 },
    { id: "humidity", min: 0, max: 100 },
    { id: "ph", min: 3.5, max: 9.5 },
    { id: "rainfall", min: 0, max: 1000 }
  ];

  let valid = true;
  let message = "";

  fields.forEach(field => {
    const value = parseFloat(document.getElementById(field.id).value);
    if (isNaN(value) || value < field.min || value > field.max) {
      valid = false;
      message += `${field.id} must be between ${field.min} and ${field.max}\n`;
    }
  });

  if (!valid) {
    e.preventDefault();
    alert("‚ö†Ô∏è Invalid input:\n" + message);
  }
});
</script>

</body>
</html>













