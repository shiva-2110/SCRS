

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Login - Smart CropX</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body{background: linear-gradient(135deg,#a8edea 0%,#fed6e3 100%);font-family:Segoe UI,Roboto,Arial,sans-serif}
    .card{max-width:520px;margin:48px auto;padding:24px;border-radius:12px}
  </style>
</head>
<body>
  <div class="card bg-white shadow-sm">
    <h3 class="mb-3">Login</h3>
    <div class="mb-2">
      <label for="languageSelect" class="form-label visually-hidden">Language</label>
      <select id="languageSelect" class="form-select form-select-sm w-auto">
        <option value="en">English</option>
        <option value="hi">हिन्दी</option>
        <option value="mr">मराठी</option>
      </select>
    </div>
    <form id="loginForm">
      <div class="mb-3 form-check form-switch">
        <input class="form-check-input" type="checkbox" id="adminMode">
        <label class="form-check-label" for="adminMode">Admin mode</label>
      </div>
      <div id="userFields">
        <div class="mb-3">
          <label class="form-label" for="mobile">Mobile</label>
          <input id="mobile" type="tel" class="form-control" required title="Mobile number" placeholder="Enter mobile number" />
        </div>
      </div>
      <div id="adminFields" style="display:none;">
        <div class="mb-3">
          <label class="form-label" for="adminUser">Admin Username</label>
          <div class="input-group">
            <input id="adminUser" class="form-control" title="Admin username" placeholder="Enter admin username" />
            <button id="autofillAdmin" type="button" class="btn btn-outline-secondary">Auto-fill</button>
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label" for="adminPass">Admin Password</label>
          <input id="adminPass" type="password" class="form-control" title="Admin password" placeholder="Enter admin password" />
        </div>
      </div>
  <button id="btnLogin" class="btn btn-primary w-100" type="submit">Login</button>
    </form>
    <div id="msg" class="mt-3"></div>
    <div class="mt-3 text-end">
      <a href="{{url_for('register_page')}}">New user? Register</a>
    </div>
  </div>

  <script>
    // initialize language selector
    const langSelect = document.getElementById('languageSelect');
    const savedLang = localStorage.getItem('lang') || 'en';
    langSelect.value = savedLang;
    langSelect.addEventListener('change', function(){ localStorage.setItem('lang', this.value); });
    const adminModeCheckbox = document.getElementById('adminMode');
    adminModeCheckbox.addEventListener('change', function(){
      const isAdmin = this.checked;
      document.getElementById('userFields').style.display = isAdmin ? 'none' : '';
      document.getElementById('adminFields').style.display = isAdmin ? '' : 'none';
      // Toggle required attributes to avoid HTML5 validation on hidden fields
      const mobileEl = document.getElementById('mobile');
      const adminUserEl = document.getElementById('adminUser');
      const adminPassEl = document.getElementById('adminPass');
      if(mobileEl) mobileEl.required = !isAdmin;
      if(adminUserEl) adminUserEl.required = isAdmin;
      if(adminPassEl) adminPassEl.required = isAdmin;
      if(isAdmin){
        adminUserEl && adminUserEl.focus();
      } else {
        mobileEl && mobileEl.focus();
      }
    });
    document.getElementById('autofillAdmin').addEventListener('click', function(){
      document.getElementById('adminUser').value = 'admin';
      document.getElementById('adminPass').value = 'adminpass';
    });
    const loginForm = document.getElementById('loginForm');
    const btnLogin = document.getElementById('btnLogin');
    btnLogin.addEventListener('click', function(){
      console.log('Login button clicked, adminMode=', adminModeCheckbox.checked);
    });

    loginForm.addEventListener('submit', async function(e){
      e.preventDefault();
      if(adminModeCheckbox.checked){
        const user = document.getElementById('adminUser').value.trim();
        const pwd = document.getElementById('adminPass').value.trim();
        console.log('Attempting admin login with', user, '*****');
        try{
          const res = await fetch('https://web-production-25adc.up.railway.app/api/admin/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:user,password:pwd})});
          const text = await res.text();
          let data = {};
          try{ data = JSON.parse(text); } catch(e){ data = { error: text }; }
          console.log('Admin login response status', res.status, data);
          if(res.ok){
            localStorage.setItem('adminToken', data.token);
            document.getElementById('msg').innerHTML = '<div class="alert alert-success">Admin logged in. Redirecting...</div>';
            setTimeout(()=> location.href='/admin/dashboard',800);
          } else {
            document.getElementById('msg').innerHTML = `<div class="alert alert-danger">${data.error||'Login failed'} (status ${res.status})</div>`;
          }
        }catch(err){
          console.error('Admin login fetch error', err);
          document.getElementById('msg').innerHTML = `<div class="alert alert-danger">Could not contact server: ${err.message}</div>`;
        }
      } else {
        const mobile = document.getElementById('mobile').value.trim();
        try{
          const res = await fetch('https://web-production-25adc.up.railway.app/api/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({mobile})});
            const data = await res.json();
            if(res.ok){
              // store mobile and username for prediction linking and welcome
              localStorage.setItem('mobile', mobile);
              // prefer server-provided name, fallback to mobile if missing
              try{ localStorage.setItem('username', data.name || mobile); } catch(e){ localStorage.setItem('username', mobile); }
              console.log('Stored mobile and username in localStorage:', localStorage.getItem('mobile'), localStorage.getItem('username'));
              document.getElementById('msg').innerHTML = '<div class="alert alert-success">Logged in. Redirecting to prediction page...</div>';
              setTimeout(()=> location.href='/predict-page',900);
            } else {
              document.getElementById('msg').innerHTML = `<div class="alert alert-danger">${data.error||'Login failed'}</div>`;
            }
        }catch(err){
          document.getElementById('msg').innerHTML = '<div class="alert alert-danger">Could not contact server</div>';
        }
      }
    });
  </script>
</body>
</html>








